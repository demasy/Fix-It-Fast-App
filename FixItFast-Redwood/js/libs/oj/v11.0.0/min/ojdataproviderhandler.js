/**
 * @license
 * Copyright (c) 2014, 2021, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["exports","preact"],function(t,e){"use strict";var a=function(t,e,a,n){return new(a||(a=Promise))(function(r,i){function s(t){try{d(n.next(t))}catch(t){i(t)}}function o(t){try{d(n.throw(t))}catch(t){i(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof a?e:new a(function(t){t(e)})).then(s,o)}d((n=n.apply(t,e||[])).next())})};class n{static getUpdatedItemsFromMutationDetail(t,e,r){return a(this,void 0,void 0,function*(){const{add:a,remove:i,update:s}=null!=t?t:{},o=new Map;for(const[t,a]of e.entries())o.set(a.key,t);let d=[...e];return i&&(d=n._removeItemsFromDetail(i,d,o)),a&&(d=yield n._addItemsFromDetail(a,d,o,r)),s&&(d=yield n._updateItemsFromDetail(s,d,o,r)),d})}static _addItemsAtEnd(t,e,a){const n=[...a];return t.forEach((t,a)=>{var r;const i={data:t,key:null===(r=e[a])||void 0===r?void 0:r.key,metadata:e[a]};n.push(i)}),n}static _addItemsAtIndices(t,e,a,n){const r=[...n];return t.forEach((t,n)=>{var i;const s={data:e[n],key:null===(i=a[n])||void 0===i?void 0:i.key,metadata:a[n]};t>=0?r.splice(t,0,s):r.push(s)}),r}static _addItemsBeforeKeys(t,e,a,r){const i=[],s=[];return t.forEach(t=>{i.push(n._getIndexByKey(r,t)),s.push({key:t})}),n._addItemsAtIndices(i,e,s,a)}static _addItemsFromDetail(t,e,r,i){var s;return a(this,void 0,void 0,function*(){const{addBeforeKeys:a,afterKeys:o,data:d,indexes:l,keys:c,metadata:u}=t;let h=[...e],v=d||[],y=u||[];if(0===v.length&&(null==c?void 0:c.size)){const t=null!==(s=yield n._fetchDataByKeys(i,c))&&void 0!==s?s:[];v=t.map(t=>t.data),y=t.map(t=>t.metadata)}return 0===y.length&&(null==c?void 0:c.size)&&(y=[...c].map(t=>({key:t}))),v.length&&(h=(null==l?void 0:l.length)?n._addItemsAtIndices(l,v,y,h):(null==a?void 0:a.length)?n._addItemsBeforeKeys(a,v,h,r):(null==o?void 0:o.size)?n._addItemsBeforeKeys([...o],v,h,r):n._addItemsAtEnd(v,y,h)),h})}static _fetchDataByKeys(t,e){return a(this,void 0,void 0,function*(){const a=[],n=(yield t.fetchByKeys({keys:e})).results;for(const t of e)if(n.has(t)){const e=n.get(t);a.push(Object.assign(Object.assign({},e),{key:t}))}return a})}static _getIndexByKey(t,e){return t.has(e)?t.get(e):-1}static _removeItemsAtIndices(t,e){const a=[...e];return t.sort((t,e)=>e-t),t.forEach(t=>{t<a.length&&a.splice(t,1)}),a}static _removeItemsAtKeys(t,e,a){const r=[];return t.forEach(t=>{const e=n._getIndexByKey(a,t);-1!==e&&r.push(e)}),n._removeItemsAtIndices(r,e)}static _removeItemsFromDetail(t,e,a){const{indexes:r,keys:i}=t;let s=[...e];return(null==r?void 0:r.length)?s=n._removeItemsAtIndices(r,s):(null==i?void 0:i.size)&&(s=n._removeItemsAtKeys(i,s,a)),s}static _updateItemsAtIndices(t,e,a,n){const r=[...n];return t.forEach((t,n)=>{var i;if(r[t]){const s={data:e[n],key:null===(i=a[n])||void 0===i?void 0:i.key,metadata:a[n]};r.splice(t,1,s)}}),r}static _updateItemsAtKeys(t,e,a,n,r){const i=[...n];return t.forEach(t=>{var n;const s=this._getIndexByKey(r,t),o={data:e[s],key:null===(n=a[s])||void 0===n?void 0:n.key,metadata:a[s]};s>=0&&i.splice(s,1,o)}),i}static _updateItemsFromDetail(t,e,r,i){var s;return a(this,void 0,void 0,function*(){const{data:a,indexes:o,keys:d,metadata:l}=t;let c=[...e],u=a||[],h=l||[];if(0===u.length&&(null==d?void 0:d.size)){const t=null!==(s=yield n._fetchDataByKeys(i,d))&&void 0!==s?s:[];u=t.map(t=>t.data),h=t.map(t=>t.metadata)}return 0===h.length&&(null==d?void 0:d.size)&&(h=[...d].map(t=>({key:t}))),u.length&&((null==o?void 0:o.length)?c=n._updateItemsAtIndices(o,u,h,c):(null==d?void 0:d.size)&&(c=n._updateItemsAtKeys(d,u,h,c,r))),c})}}var r=function(t,e,a,n){return new(a||(a=Promise))(function(r,i){function s(t){try{d(n.next(t))}catch(t){i(t)}}function o(t){try{d(n.throw(t))}catch(t){i(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof a?e:new a(function(t){t(e)})).then(s,o)}d((n=n.apply(t,e||[])).next())})},i=function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,a=t[Symbol.asyncIterator];return a?a.call(t):(t="function"==typeof __values?__values(t):t[Symbol.iterator](),e={},n("next"),n("throw"),n("return"),e[Symbol.asyncIterator]=function(){return this},e);function n(a){e[a]=t[a]&&function(e){return new Promise(function(n,r){(function(t,e,a,n){Promise.resolve(n).then(function(e){t({value:e,done:a})},e)})(n,r,(e=t[a](e)).done,e.value)})}}};class s{constructor(t,e,a){this._handleMutateEvent=t=>r(this,void 0,void 0,function*(){var e,a;const{detail:r}=t,i=this._addBusyState("updating data from mutation event"),s=yield n.getUpdatedItemsFromMutationDetail(r,this._currentData,this._dataProvider);null==i||i(),this._currentData=s,null===(a=null===(e=this._callback)||void 0===e?void 0:e.onDataUpdated)||void 0===a||a.call(e,s)}),this._handleRefreshEvent=t=>{this._fetchDataAndNotify()},this._addBusyState=e,this._callback=a,this._dataProvider=t,this._currentData=[],t.addEventListener("refresh",this._handleRefreshEvent),t.addEventListener("mutate",this._handleMutateEvent),this._fetchDataAndNotify()}destroy(){this._callback=void 0,this._currentData=[],this._dataProvider.removeEventListener("refresh",this._handleRefreshEvent),this._dataProvider.removeEventListener("mutate",this._handleMutateEvent)}_fetchData(){var t,e;return r(this,void 0,void 0,function*(){const a=[],n=this._dataProvider.fetchFirst({size:-1});try{for(var r,s=i(n);!(r=yield s.next()).done;){const t=r.value,e=t.data.map((e,a)=>({data:e,key:t.metadata[a].key,metadata:t.metadata[a]}));a.push(...e)}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=s.return)&&(yield e.call(s))}finally{if(t)throw t.error}}return this._currentData=a.slice(),a})}_fetchDataAndNotify(){var t,e;return r(this,void 0,void 0,function*(){const a=this._addBusyState("fetching data"),n=yield this._fetchData();null===(e=null===(t=this._callback)||void 0===t?void 0:t.onDataUpdated)||void 0===e||e.call(t,n),a()})}}var o=function(t,e){var a={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(a[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(t);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(t,n[r])&&(a[n[r]]=t[n[r]])}return a};t.withDataProvider=function(t,a){var n;return(n=class extends e.Component{constructor(t){super(t),this._handleDataUpdate=t=>{this.setState({fetchedData:t})},this.state={fetchedData:[]}}componentDidMount(){this._initDataProviderHandler()}componentDidUpdate(t){this.props.data!==t.data&&this._resetDataProviderHandler()}componentWillUnmount(){this._releaseDataProviderHandler()}render(n,r){const{data:i,addBusyState:s}=n,d=o(n,["data","addBusyState"]),{fetchedData:l}=r,c=Object.assign({[a]:l},d);return e.h(t,Object.assign({},c))}_initDataProviderHandler(){const{data:t,addBusyState:e}=this.props;null!=t&&(this._dataProviderHandler=new s(t,e,{onDataUpdated:this._handleDataUpdate}))}_releaseDataProviderHandler(){var t;null===(t=this._dataProviderHandler)||void 0===t||t.destroy(),this._dataProviderHandler=void 0}_resetDataProviderHandler(){this._releaseDataProviderHandler(),this._initDataProviderHandler()}}).displayName=`WithDataProvider(${function(t){var e,a;return null!==(a=null!==(e=t.displayName)&&void 0!==e?e:t.name)&&void 0!==a?a:"Component"}(t)})`,n},Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ojdataproviderhandler.js.map